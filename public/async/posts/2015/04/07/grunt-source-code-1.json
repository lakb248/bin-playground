{"tags":[{"name":"grunt","permalink":"/tags/grunt/","url":"\\async\\tags\\grunt.json","count":3}],"categories":[],"url":"\\async\\posts\\2015\\04\\07\\grunt-source-code-1.json","date":1428369856000,"path":{"year":2015,"month":4,"day":7,"name":"grunt-source-code-1"},"title":"看看 Grunt 的源码（一）：grunt-cli 源码解析","permalink":"/2015/04/07/grunt-source-code-1/","content":"<p>由于将来工作需要最近学习了Grunt，至于Grunt是什么大家百度下就好了，我就不多说了。对于它内部的实现比较感兴趣，所以看了看源码。今天先来说说grunt命令行工具grunt-cli的实现。</p>\n<p>grunt-cli是建立在grunt基础上的命令行工具，通过它可以很方便的使用grunt进行一些自动化任务。grunt-cli的处理过程主要分为下面几步：</p>\n<ol>\n<li>加载必须的模块，这其中包括第三方模块和grunt-cli内部的模块</li>\n<li>获取命令行参数执行相应的操作</li>\n<li>查找grunt.js文件并执行任务</li>\n</ol>\n<a id=\"more\"></a>\n<p>下面的grunt-cli的主要代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/usr/bin/env node</span></span><br><span class=\"line\"><span class=\"meta\"></span><br><span class=\"line\">'use strict'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">process.title = <span class=\"string\">'grunt'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//加载文件查找模块,findup用于向上查找</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> findup = <span class=\"built_in\">require</span>(<span class=\"string\">'findup-sync'</span>);</span><br><span class=\"line\"><span class=\"comment\">//加载路径解析模块</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> resolve = <span class=\"built_in\">require</span>(<span class=\"string\">'resolve'</span>).sync;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//加载grunt-cli内部的cli模块</span></span><br><span class=\"line\"><span class=\"comment\">//cli模块利用nopt第三方库来获取grunt命令中的参数值</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> options = <span class=\"built_in\">require</span>(<span class=\"string\">'../lib/cli'</span>).options;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//加载grunt-cli内部的completion模块</span></span><br><span class=\"line\"><span class=\"comment\">//completion模块用来打印自动补全的脚本</span></span><br><span class=\"line\"><span class=\"comment\">//这样就可以通过eval \"$(grunt --completion=bash)\"来执行脚本支持自动补全</span></span><br><span class=\"line\"><span class=\"comment\">//completion.js内部就是通过参数查找文件最后输出</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> completion = <span class=\"built_in\">require</span>(<span class=\"string\">'../lib/completion'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//加载grunt-cli内部的info模块</span></span><br><span class=\"line\"><span class=\"comment\">//用来输出版本信息以及帮助信息的模块</span></span><br><span class=\"line\"><span class=\"comment\">//info.js内部主要就是几个输出grunt信息的方法</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> info = <span class=\"built_in\">require</span>(<span class=\"string\">'../lib/info'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//加载node自带的路径解析模块</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取当前路径</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> basedir = process.cwd();</span><br><span class=\"line\"><span class=\"comment\">//grunt.js文件的路径</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> gruntpath;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//判断命令行参数进行相应操作</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"string\">'completion'</span> <span class=\"keyword\">in</span> options) &#123;</span><br><span class=\"line\"><span class=\"comment\">//如果grunt命令带有--completion参数，则打印相应的自动补全脚本</span></span><br><span class=\"line\"><span class=\"comment\">//grunt --completion=bash这个命令基本上只会在设置自动补全的使用</span></span><br><span class=\"line\"><span class=\"comment\">//在自动化工作中并不会用到</span></span><br><span class=\"line\">completion.print(options.completion);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options.version) &#123;</span><br><span class=\"line\"><span class=\"comment\">//如果grunt命令带有--version参数，则打印版本信息</span></span><br><span class=\"line\">info.version();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options.base &amp;&amp; !options.gruntfile) &#123;</span><br><span class=\"line\"><span class=\"comment\">//如果在grunt命令中指定了base文件夹</span></span><br><span class=\"line\"><span class=\"comment\">//那么所有操作都会基于这个文件路径进行</span></span><br><span class=\"line\">basedir = path.resolve(options.base);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options.gruntfile) &#123;</span><br><span class=\"line\"><span class=\"comment\">//如果grunt命令中指定了gruntfile，那么就会执行这个文件中的任务，同时文件夹切换到对于目录下</span></span><br><span class=\"line\"><span class=\"comment\">//默认情况下grunt会在当前目录以及父目录中查找Gruntfile.js或者Gruntfile.coffee文件</span></span><br><span class=\"line\">basedir = path.resolve(path.dirname(options.gruntfile));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">//得到grunt.js的地址</span></span><br><span class=\"line\">gruntpath = resolve(<span class=\"string\">'grunt'</span>, &#123;basedir: basedir&#125;);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (ex) &#123;</span><br><span class=\"line\"><span class=\"comment\">//如果在当前路径没找到，向父目录继续查找</span></span><br><span class=\"line\">gruntpath = findup(<span class=\"string\">'lib/grunt.js'</span>);</span><br><span class=\"line\"><span class=\"comment\">// No grunt install found!</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!gruntpath) &#123;</span><br><span class=\"line\">  <span class=\"comment\">//无法找到目录</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.version) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//如果查询版本信息，由于找不到grunt所以直接退出</span></span><br><span class=\"line\">    process.exit();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.help) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//显示帮助信息</span></span><br><span class=\"line\">    info.help();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  info.fatal(<span class=\"string\">'Unable to find local grunt.'</span>, <span class=\"number\">99</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//调用grunt执行任务，精彩从这里开始</span></span><br><span class=\"line\"><span class=\"built_in\">require</span>(gruntpath).cli();</span><br></pre></td></tr></table></figure>\n<p>整个过程比较简单，真正有意思的工作在grunt.js中，后续我会跟大家分享这方面的内容。</p>\n"}