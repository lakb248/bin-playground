{"tags":[{"name":"grunt","permalink":"/tags/grunt/","url":"/async/tags/grunt.json","count":2}],"categories":[],"url":"/async/posts/2015/04/07/grunt-source-code-1.json","date":1428389213000,"path":{"year":2015,"month":4,"day":7,"name":"grunt-source-code-1"},"title":"看看 Grunt 的源码（一）：grunt-cli 源码解析","permalink":"/2015/04/07/grunt-source-code-1/","content":"<p>由于将来工作需要最近学习了Grunt，至于Grunt是什么大家百度下就好了，我就不多说了。对于它内部的实现比较感兴趣，所以看了看源码。今天先来说说grunt命令行工具grunt-cli的实现。<br><a id=\"more\"></a><br>grunt-cli是建立在grunt基础上的命令行工具，通过它可以很方便的使用grunt进行一些自动化任务。grunt-cli的处理过程主要分为下面几步：</p>\n<ol>\n<li>加载必须的模块，这其中包括第三方模块和grunt-cli内部的模块</li>\n<li>获取命令行参数执行相应的操作</li>\n<li>查找grunt.js文件并执行任务</li>\n</ol>\n<p>下面的grunt-cli的主要代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#!/usr/bin/env node</span></div><div class=\"line\"><span class=\"meta\"></span></div><div class=\"line\">'use strict';</div><div class=\"line\"></div><div class=\"line\">process.title = <span class=\"string\">'grunt'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载文件查找模块,findup用于向上查找</span></div><div class=\"line\"><span class=\"keyword\">var</span> findup = <span class=\"built_in\">require</span>(<span class=\"string\">'findup-sync'</span>);</div><div class=\"line\"><span class=\"comment\">//加载路径解析模块</span></div><div class=\"line\"><span class=\"keyword\">var</span> resolve = <span class=\"built_in\">require</span>(<span class=\"string\">'resolve'</span>).sync;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载grunt-cli内部的cli模块</span></div><div class=\"line\"><span class=\"comment\">//cli模块利用nopt第三方库来获取grunt命令中的参数值</span></div><div class=\"line\"><span class=\"keyword\">var</span> options = <span class=\"built_in\">require</span>(<span class=\"string\">'../lib/cli'</span>).options;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载grunt-cli内部的completion模块</span></div><div class=\"line\"><span class=\"comment\">//completion模块用来打印自动补全的脚本</span></div><div class=\"line\"><span class=\"comment\">//这样就可以通过eval \"$(grunt --completion=bash)\"来执行脚本支持自动补全</span></div><div class=\"line\"><span class=\"comment\">//completion.js内部就是通过参数查找文件最后输出</span></div><div class=\"line\"><span class=\"keyword\">var</span> completion = <span class=\"built_in\">require</span>(<span class=\"string\">'../lib/completion'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载grunt-cli内部的info模块</span></div><div class=\"line\"><span class=\"comment\">//用来输出版本信息以及帮助信息的模块</span></div><div class=\"line\"><span class=\"comment\">//info.js内部主要就是几个输出grunt信息的方法</span></div><div class=\"line\"><span class=\"keyword\">var</span> info = <span class=\"built_in\">require</span>(<span class=\"string\">'../lib/info'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//加载node自带的路径解析模块</span></div><div class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//获取当前路径</span></div><div class=\"line\"><span class=\"keyword\">var</span> basedir = process.cwd();</div><div class=\"line\"><span class=\"comment\">//grunt.js文件的路径</span></div><div class=\"line\"><span class=\"keyword\">var</span> gruntpath;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//判断命令行参数进行相应操作</span></div><div class=\"line\"><span class=\"keyword\">if</span> (<span class=\"string\">'completion'</span> <span class=\"keyword\">in</span> options) &#123;</div><div class=\"line\"><span class=\"comment\">//如果grunt命令带有--completion参数，则打印相应的自动补全脚本</span></div><div class=\"line\"><span class=\"comment\">//grunt --completion=bash这个命令基本上只会在设置自动补全的使用</span></div><div class=\"line\"><span class=\"comment\">//在自动化工作中并不会用到</span></div><div class=\"line\">completion.print(options.completion);</div><div class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options.version) &#123;</div><div class=\"line\"><span class=\"comment\">//如果grunt命令带有--version参数，则打印版本信息</span></div><div class=\"line\">info.version();</div><div class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options.base &amp;&amp; !options.gruntfile) &#123;</div><div class=\"line\"><span class=\"comment\">//如果在grunt命令中指定了base文件夹</span></div><div class=\"line\"><span class=\"comment\">//那么所有操作都会基于这个文件路径进行</span></div><div class=\"line\">basedir = path.resolve(options.base);</div><div class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (options.gruntfile) &#123;</div><div class=\"line\"><span class=\"comment\">//如果grunt命令中指定了gruntfile，那么就会执行这个文件中的任务，同时文件夹切换到对于目录下</span></div><div class=\"line\"><span class=\"comment\">//默认情况下grunt会在当前目录以及父目录中查找Gruntfile.js或者Gruntfile.coffee文件</span></div><div class=\"line\">basedir = path.resolve(path.dirname(options.gruntfile));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">try</span> &#123;</div><div class=\"line\"><span class=\"comment\">//得到grunt.js的地址</span></div><div class=\"line\">gruntpath = resolve(<span class=\"string\">'grunt'</span>, &#123;basedir: basedir&#125;);</div><div class=\"line\">&#125; <span class=\"keyword\">catch</span> (ex) &#123;</div><div class=\"line\"><span class=\"comment\">//如果在当前路径没找到，向父目录继续查找</span></div><div class=\"line\">gruntpath = findup(<span class=\"string\">'lib/grunt.js'</span>);</div><div class=\"line\"><span class=\"comment\">// No grunt install found!</span></div><div class=\"line\"><span class=\"keyword\">if</span> (!gruntpath) &#123;</div><div class=\"line\">  <span class=\"comment\">//无法找到目录</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (options.version) &#123;</div><div class=\"line\">    <span class=\"comment\">//如果查询版本信息，由于找不到grunt所以直接退出</span></div><div class=\"line\">    process.exit();</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"keyword\">if</span> (options.help) &#123;</div><div class=\"line\">    <span class=\"comment\">//显示帮助信息</span></div><div class=\"line\">    info.help();</div><div class=\"line\">  &#125;</div><div class=\"line\">  info.fatal(<span class=\"string\">'Unable to find local grunt.'</span>, <span class=\"number\">99</span>);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//调用grunt执行任务，精彩从这里开始</span></div><div class=\"line\"><span class=\"built_in\">require</span>(gruntpath).cli();</div></pre></td></tr></table></figure>\n<p>整个过程比较简单，真正有意思的工作在grunt.js中，后续我会跟大家分享这方面的内容。</p>\n"}